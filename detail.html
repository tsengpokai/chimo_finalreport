<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>詳細內容</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* 新增微震遊戲樣式 */
        #micro-canvas { width: 100%; height: 250px; background: #000; border: 1px solid #333; margin-top: 10px; border-radius: 4px; }
        .monitor-panel { display: flex; justify-content: space-between; margin-top: 10px; font-family: monospace; color: #0f0; }
    </style>
</head>
<body>
    <canvas id="geo-canvas"></canvas>

    <div class="detail-container">
        <br>
        <a href="index.html" style="color:var(--accent-cyan); text-decoration:none; font-size:1.1rem; font-weight:bold;">
            <i class="fas fa-arrow-left"></i> 返回時間軸
        </a>
        
        <div id="content-wrapper" style="background: rgba(13, 22, 35, 0.9); border: 1px solid var(--accent-cyan); padding: 40px; border-radius: 16px; margin-top: 20px;">
            </div>
    </div>

    <script src="data.js"></script>
    <script src="script.js"></script>
    <script>
        // Detail Page Logic
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const data = courseData[id];
        const wrapper = document.getElementById('content-wrapper');

        if(data) {
            let html = `
                <div style="border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 30px;">
                    <div style="color: var(--accent-cyan); font-family: 'Orbitron'; margin-bottom: 10px;">${data.date}</div>
                    <h1 style="font-size: 2.5rem; margin-bottom: 15px; color:white;">${data.title}</h1>
                    <div>${data.tags.map(t => `<span style="background:rgba(0,242,255,0.1); color:var(--accent-cyan); padding:4px 8px; margin-right:5px; border-radius:4px; font-size:0.8rem;">#${t}</span>`).join('')}</div>
                </div>
            `;

            data.content.forEach(item => {
                if(item.type === 'text') {
                    html += `<div style="margin-bottom:25px;"><h3 style="color:var(--accent-blue); margin-bottom:10px;">${item.heading || ''}</h3><p style="color:#ddd; line-height:1.8;">${item.body}</p></div>`;
                } else if (item.type === 'image') {
                     html += `
                        <div style="text-align:center; margin: 20px 0; border: 1px dashed #555; padding: 20px;">
                            ${item.src.includes('http') || item.src.includes('.jpg') ? 
                                `<img src="${item.src}" alt="${item.caption}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                                 <div style="display:none; color:orange;">[圖片] 請將 ${item.src} 放入資料夾</div>` 
                                : ``
                            }
                            <p style="color:#aaa; font-size:0.9rem; margin-top:5px;">${item.caption}</p>
                        </div>`;
                } else if (item.type === 'math') {
                    html += `<div style="background:rgba(0,0,0,0.3); padding:15px; border-left:3px solid var(--accent-cyan); margin:15px 0;"><strong>${item.heading}</strong><div style="margin-top:10px;">${item.body}</div></div>`;
                } else if (item.type === 'iframe') {
                    html += `<div style="margin:30px 0;"><iframe src="${item.src}" width="100%" height="500" style="border:none; border-radius:8px; background:#000;"></iframe><p style="text-align:center; color:#aaa; margin-top:5px;">${item.caption}</p></div>`;
                } else if (item.type === 'link_group') {
                    html += `<div style="margin-top:20px;">${item.links.map(l=>`<a href="${l.url}" target="_blank" style="background:var(--accent-blue); color:white; padding:10px 20px; text-decoration:none; border-radius:5px; margin-right:10px;">${l.text}</a>`).join('')}</div>`;
                }
                
                // --- Game 1: 磁條帶 (保留) ---
                else if (item.type === 'game_magnetic') {
                    html += `
                        <div class="game-box">
                            <h2 style="color:var(--accent-cyan); text-align:center;"><i class="fas fa-magnet"></i> ${item.heading}</h2>
                            <p style="color:#ccc; text-align:center; margin-bottom:15px;">${item.caption}</p>
                            <label style="color:#aaa;">時間軸 (Ma): <span id="mag-time-val">0</span></label>
                            <input type="range" id="mag-slider" min="0" max="100" value="0">
                            <canvas id="mag-canvas"></canvas>
                        </div>`;
                }
                // --- Game 2: 熱流模擬器 (還原上一版: 鑽井視覺化) ---
                else if (item.type === 'game_heat') {
                    html += `
                        <div class="game-box">
                            <h2 style="color:var(--accent-cyan); text-align:center;"><i class="fas fa-fire"></i> ${item.heading}</h2>
                            <p style="color:#ccc; text-align:center; margin-bottom:20px;">${item.caption}</p>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:40px;">
                                <div>
                                    <div class="slider-group">
                                        <label style="color:#fff;">導熱係數 k: <span id="val-k">2.5</span></label>
                                        <input type="range" id="in-k" min="1.0" max="5.0" step="0.1" value="2.5">
                                    </div>
                                    <div class="slider-group">
                                        <label style="color:#fff;">地溫梯度: <span id="val-grad">30</span></label>
                                        <input type="range" id="in-grad" min="10" max="80" step="1" value="30">
                                    </div>
                                    <div class="slider-group">
                                        <label style="color:#fff;">鑽井深度 (km): <span id="val-depth">3.0</span></label>
                                        <input type="range" id="in-depth" min="1.0" max="10.0" step="0.5" value="3.0">
                                    </div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="color:#aaa;">井底溫度</div>
                                    <div style="font-size:3rem; color:var(--accent-cyan); font-weight:bold;"><span id="res-temp">110</span>°C</div>
                                    <div class="visualizer" id="vis-bg" style="height:150px; background:#333; margin-top:10px; position:relative; overflow:hidden; border:1px solid #555;">
                                        <div id="vis-drill" style="position:absolute; left:50%; top:0; width:4px; height:30%; background:#fff; transition:0.2s;"></div>
                                        <div style="position:absolute; bottom:5px; right:5px; color:#fff; font-size:0.8rem;" id="depth-text">3km</div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }
                // --- Game 3: 微震監測 (新增) ---
                else if (item.type === 'game_microseismic') {
                    html += `
                        <div class="game-box">
                            <h2 style="color:var(--accent-cyan); text-align:center;"><i class="fas fa-wave-square"></i> ${item.heading}</h2>
                            <p style="color:#ccc; text-align:center;">${item.caption}</p>
                            <label style="color:#aaa;">注水壓力 (Pressure): <span id="pressure-val">0</span> MPa</label>
                            <input type="range" id="pressure-input" min="0" max="100" value="0" step="1">
                            
                            <canvas id="micro-canvas"></canvas>
                            <div class="monitor-panel">
                                <div>Status: <span id="status-text">SAFE</span></div>
                                <div>Events: <span id="event-count">0</span></div>
                            </div>
                        </div>`;
                }
            });
            wrapper.innerHTML = html;

            // 初始化遊戲
            setTimeout(() => {
                if(document.getElementById('mag-slider')) initMagneticGame();
                if(document.getElementById('in-k')) initHeatGame();
                if(document.getElementById('pressure-input')) initMicroseismicGame();
            }, 100);
        }

        // --- Game Logic ---
        function initMagneticGame() {
            const slider = document.getElementById('mag-slider');
            const canvas = document.getElementById('mag-canvas');
            const ctx = canvas.getContext('2d');
            const timeVal = document.getElementById('mag-time-val');
            // ... (同上一版邏輯)
            const polarityHistory = [];
            for(let i=0; i<100; i++) polarityHistory.push(Math.random() > 0.5 ? 1 : 0);
            function draw() {
                const w = canvas.width = canvas.offsetWidth;
                const h = canvas.height = 150;
                const time = parseInt(slider.value);
                timeVal.innerText = time;
                const centerX = w / 2;
                const spreadRate = 3;
                ctx.clearRect(0, 0, w, h);
                ctx.fillStyle = 'red'; ctx.fillRect(centerX - 1, 0, 2, h);
                for(let t=0; t<time; t++) {
                    const color = polarityHistory[t] === 1 ? '#333' : '#fff';
                    const xOffset = (time - t) * spreadRate;
                    ctx.fillStyle = color;
                    ctx.fillRect(centerX - xOffset, 0, spreadRate, h);
                    ctx.fillRect(centerX + xOffset - spreadRate, 0, spreadRate, h);
                }
            }
            slider.addEventListener('input', draw);
            draw();
        }

        function initHeatGame() {
            const inK = document.getElementById('in-k');
            const inGrad = document.getElementById('in-grad');
            const inDepth = document.getElementById('in-depth');
            function update() {
                const k = parseFloat(inK.value);
                const g = parseFloat(inGrad.value);
                const d = parseFloat(inDepth.value);
                
                document.getElementById('val-k').innerText = k.toFixed(1);
                document.getElementById('val-grad').innerText = g;
                document.getElementById('val-depth').innerText = d.toFixed(1);
                document.getElementById('depth-text').innerText = d + "km";

                const temp = 20 + g * d;
                document.getElementById('res-temp').innerText = temp.toFixed(1);
                
                // 視覺更新
                const drillPercent = (d / 10) * 100;
                document.getElementById('vis-drill').style.height = drillPercent + '%';
                const intensity = Math.min((temp - 20) / 400, 1);
                const r = Math.floor(intensity * 255);
                document.getElementById('vis-bg').style.background = `linear-gradient(to bottom, #222, rgb(${r}, 0, 0))`;
            }
            inK.addEventListener('input', update);
            inGrad.addEventListener('input', update);
            inDepth.addEventListener('input', update);
            update();
        }

        function initMicroseismicGame() {
            const pInput = document.getElementById('pressure-input');
            const canvas = document.getElementById('micro-canvas');
            const ctx = canvas.getContext('2d');
            let pressure = 0;
            let events = []; // {x, y, life}

            pInput.addEventListener('input', (e) => {
                pressure = parseInt(e.target.value);
                document.getElementById('pressure-val').innerText = pressure;
                
                // 狀態更新
                const status = document.getElementById('status-text');
                if(pressure < 40) { status.innerText = "SAFE"; status.style.color = "#0f0"; }
                else if(pressure < 80) { status.innerText = "WARNING"; status.style.color = "yellow"; }
                else { status.innerText = "DANGER: FRACTURE"; status.style.color = "red"; }
            });

            function loop() {
                const w = canvas.width = canvas.offsetWidth;
                const h = canvas.height = 250;
                ctx.clearRect(0, 0, w, h);

                // 畫井
                ctx.strokeStyle = '#555'; ctx.lineWidth = 4;
                ctx.beginPath(); ctx.moveTo(w/2, 0); ctx.lineTo(w/2, h*0.8); ctx.stroke();

                // 產生微震
                if(Math.random() * 100 < pressure) {
                    const spread = pressure * 1.5;
                    events.push({
                        x: w/2 + (Math.random()-0.5) * spread,
                        y: h*0.8 + (Math.random()-0.5) * spread/2,
                        life: 1.0
                    });
                }

                // 繪製微震點
                events.forEach((e, i) => {
                    ctx.fillStyle = `rgba(${pressure*2.5}, ${255-pressure*2}, 0, ${e.life})`;
                    ctx.beginPath(); ctx.arc(e.x, e.y, 3, 0, Math.PI*2); ctx.fill();
                    e.life -= 0.02;
                    if(e.life <= 0) events.splice(i, 1);
                });
                
                document.getElementById('event-count').innerText = events.length;
                requestAnimationFrame(loop);
            }
            loop();
        }
    </script>
</body>
</html>